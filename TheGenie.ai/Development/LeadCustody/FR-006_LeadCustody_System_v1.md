# FR-006: Lead Custody System

---

## Executive Summary

| Field | Value |
|-------|-------|
| **Purpose** | Ensure 1PP/TheGenie retains ownership of all leads generated by the platform, enabling revenue protection when agents cancel and transaction tracking for commission splits |
| **Current State** | 0% - Discovery complete, schema designed, awaiting approval |
| **Key Outputs** | Lead custody tracking, agent license management, transaction/commission tracking, orphan lead recovery |
| **Remaining Work** | Schema implementation, data migration (56,876 orphaned leads), business rules engine, admin UI |
| **Last Validated** | 12/15/2025 - Business requirements confirmed with stakeholder |

---

## Document Information

| Field | Value |
|-------|-------|
| **Version** | 1.0 |
| **Created** | 12/15/2025 |
| **Last Updated** | 12/15/2025 |
| **Author** | Cursor AI |
| **Status** | DRAFT - Pending Approval |

---

## 1. Problem Statement

### Current State
- **85,554 total leads** exist in the GenieLead table
- **56,876 leads (66.5%)** are **orphaned** - in areas with no current owner
- **6,235 leads (7.3%)** have **mismatched ownership** - assigned to previous area owner
- **0% of leads** have transaction/commission tracking
- **No mechanism** to reclaim leads from non-performing or cancelled agents
- **No visibility** into whether referred leads ever converted to transactions

### Business Impact
1. **Lost Revenue**: When agents cancel, leads generated by 1PP campaigns become inaccessible
2. **No Commission Tracking**: Even if a lead converts to a transaction 6 months later, 1PP has no way to track or claim their split
3. **No Accountability**: Agents can take leads generated by 1PP and never compensate for them
4. **No Reassignment**: When an agent leaves, valuable leads cannot be transferred to new area owners
5. **No Performance Metrics**: Cannot identify non-performing agents who should have leads reclaimed

---

## 2. Proposed Solution

### Core Concept: Lead Custody Model

**Leads are ALWAYS owned by 1PP/TheGenie.** Agents are **licensed** to work leads while they remain active and paying customers. When an agent's status changes (cancellation, non-payment, non-performance), leads return to 1PP custody for potential reassignment.

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    1PP/GENIE = LEAD CUSTODIAN                           │
│                   (ALWAYS owns the lead asset)                          │
│                                                                         │
│   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐          │
│   │ LeadCustody   │    │ LeadCustody   │    │ LeadCustody   │          │
│   │ Status:       │    │ Status:       │    │ Status:       │          │
│   │ AgentLicensed │    │ 1PPCustody    │    │ Converted     │          │
│   └───────┬───────┘    └───────────────┘    └───────┬───────┘          │
│           │                                         │                   │
│           ▼                                         ▼                   │
│   ┌───────────────┐                         ┌───────────────┐          │
│   │ Agent works   │                         │ LeadTransaction│          │
│   │ the lead      │                         │ SplitTo1PP    │          │
│   └───────────────┘                         │ calculated    │          │
│                                             └───────────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Business Rules

| Rule ID | Rule | Description |
|---------|------|-------------|
| **BR-001** | 1PP Always Owns | Every lead created by a Genie campaign is a 1PP asset; agents only have a license to work it |
| **BR-002** | License Follows Payment | When agent stops paying, their license expires and leads return to 1PP custody |
| **BR-003** | 30-Day Grace Period | After cancellation, agent has 30 days to convert leads before they become available for reassignment |
| **BR-004** | Split Survives Transfer | If a lead converts to a transaction, 1PP gets their split percentage regardless of current licensee |
| **BR-005** | Area Ownership Link | New leads are tied to AreaOwnership record, not just AreaId |
| **BR-006** | Performance Reclaim | Leads can be reclaimed from non-performing agents (no activity in X days) |
| **BR-007** | Inherit Split Percentage | New leads inherit SplitPercentage from AreaOwnership.DefaultSplitPercentage |
| **BR-008** | Custody Audit Trail | All custody changes are logged in LeadCustodyHistory |

---

## 4. Schema Design

### New Tables

#### 4.1 LeadCustody
Primary table tracking custody status of each lead.

| Column | Type | Description |
|--------|------|-------------|
| LeadCustodyId | BIGINT PK | Primary key |
| GenieLeadId | BIGINT FK | Link to GenieLead |
| CustodyStatusTypeId | INT FK | Current status (see lookup) |
| CurrentLicenseeUserId | NVARCHAR(128) FK | Agent currently licensed (NULL = 1PP custody) |
| SourceAreaOwnershipId | INT FK | Link to AreaOwnership record |
| SplitPercentage | DECIMAL(5,2) | 1PP's cut if transaction happens |
| GracePeriodEndDate | DATETIME | When grace period expires after cancellation |
| CreateDate | DATETIME | Record creation |
| LastUpdateDate | DATETIME | Last modification |

#### 4.2 LeadCustodyHistory
Audit trail for all custody changes.

| Column | Type | Description |
|--------|------|-------------|
| LeadCustodyHistoryId | BIGINT PK | Primary key |
| LeadCustodyId | BIGINT FK | Link to LeadCustody |
| FromUserId | NVARCHAR(128) FK | Previous licensee (NULL = was 1PP) |
| ToUserId | NVARCHAR(128) FK | New licensee (NULL = now 1PP) |
| CustodyTransferReasonId | INT FK | Why transfer happened |
| TransferredByUserId | NVARCHAR(128) FK | Admin who initiated |
| TransferDate | DATETIME | When transfer occurred |
| Notes | NVARCHAR(500) | Optional notes |

#### 4.3 LeadTransaction
Tracks when leads convert to actual real estate transactions.

| Column | Type | Description |
|--------|------|-------------|
| LeadTransactionId | BIGINT PK | Primary key |
| LeadCustodyId | BIGINT FK | Link to LeadCustody |
| GenieLeadId | BIGINT FK | Link to GenieLead |
| TransactionDate | DATE | When deal closed |
| TransactionAmount | MONEY | Sale price |
| CommissionTotal | MONEY | Total commission earned |
| SplitTo1PP | MONEY | 1PP's portion |
| SplitToAgent | MONEY | Agent's portion |
| AgentUserIdAtClose | NVARCHAR(128) FK | Who had license when closed |
| VerifiedDate | DATETIME | When transaction was verified |
| VerifiedByUserId | NVARCHAR(128) FK | Who verified |
| CreateDate | DATETIME | Record creation |

### Lookup Tables

#### 4.4 CustodyStatusType

| CustodyStatusTypeId | StatusName | Description |
|---------------------|------------|-------------|
| 1 | 1PPCustody | Lead is in 1PP custody, available for licensing |
| 2 | AgentLicensed | Lead is licensed to an active agent |
| 3 | AgentSuspended | Agent in grace period (cancelled but not expired) |
| 4 | Reclaimed | Lead was reclaimed from non-performer |
| 5 | Converted | Lead resulted in a transaction |

#### 4.5 CustodyTransferReason

| CustodyTransferReasonId | ReasonName |
|-------------------------|------------|
| 1 | InitialAssignment |
| 2 | AgentCancelled |
| 3 | NonPayment |
| 4 | Reclaimed |
| 5 | AreaTransfer |
| 6 | ManualAdmin |

---

## 5. Integration Points

### 5.1 With AreaOwnership (FR-001)
- `LeadCustody.SourceAreaOwnershipId` links to `AreaOwnership.AreaOwnershipId`
- When AreaOwnership status changes to "Ended", trigger lead custody review
- `AreaOwnership.LeadCustodyEnabled` flag controls whether new leads get custody records
- `AreaOwnership.DefaultSplitPercentage` is inherited by new leads

### 5.2 With GenieLead (Existing)
- `LeadCustody.GenieLeadId` links to `GenieLead.GenieLeadId`
- One-to-one relationship (every lead has exactly one custody record)
- GenieLead.AspNetUserId becomes historical; CurrentLicenseeUserId is source of truth

### 5.3 With Referral System (Future FR-005)
- If lead originated from referral, track for referrer commission
- Referrer split is in addition to 1PP split

### 5.4 With WHMCS Billing
- Agent cancellation triggers custody status change
- Payment failure triggers grace period
- Re-activation can restore license

---

## 6. Data Migration

### 6.1 Existing Lead Analysis

| Category | Count | Migration Action |
|----------|-------|------------------|
| Leads with active area owner | 22,443 | Create LeadCustody with status=AgentLicensed |
| Orphaned leads (no area owner) | 56,876 | Create LeadCustody with status=1PPCustody |
| Mismatched leads | 6,235 | Create LeadCustody with status=1PPCustody + history record |

### 6.2 Migration Steps

1. **Create lookup tables** with seed data
2. **Create LeadCustody table** 
3. **Bulk insert** custody records for all existing leads
4. **Set status** based on current UserOwnedArea state
5. **Create history records** for orphaned/mismatched leads
6. **Verify counts** match expected totals

### 6.3 Migration Script (Pseudo-SQL)

```sql
-- Step 1: Create custody records for all leads
INSERT INTO LeadCustody (
    GenieLeadId,
    CustodyStatusTypeId,
    CurrentLicenseeUserId,
    SourceAreaOwnershipId,
    SplitPercentage,
    CreateDate,
    LastUpdateDate
)
SELECT 
    gl.GenieLeadId,
    CASE 
        WHEN uoa.AspNetUserId IS NOT NULL AND gl.AspNetUserId = uoa.AspNetUserId THEN 2 -- AgentLicensed
        ELSE 1 -- 1PPCustody
    END,
    CASE 
        WHEN uoa.AspNetUserId IS NOT NULL AND gl.AspNetUserId = uoa.AspNetUserId THEN uoa.AspNetUserId
        ELSE NULL
    END,
    NULL, -- SourceAreaOwnershipId will be populated after AreaOwnership migration
    25.00, -- Default 25% split to 1PP
    GETDATE(),
    GETDATE()
FROM GenieLead gl
LEFT JOIN UserOwnedArea uoa ON gl.AreaId = uoa.AreaId;
```

---

## 7. User Interface Requirements

### 7.1 Admin Dashboard
- View all leads by custody status
- Filter by area, agent, date range
- Bulk reassignment tools
- Transaction entry/verification

### 7.2 Agent Portal
- View licensed leads
- Mark leads as "converted" (triggers transaction entry)
- See grace period countdown if cancelled

### 7.3 Reports
- Orphaned lead recovery report
- Transaction/commission report
- Agent performance report (leads per agent, conversion rate)
- Revenue protection report (potential lost commissions)

---

## 8. Implementation Phases

### Phase 1: Schema & Migration (Week 1-2)
- [ ] Create database tables
- [ ] Seed lookup data
- [ ] Migrate existing leads
- [ ] Verify data integrity

### Phase 2: Business Rules Engine (Week 3-4)
- [ ] Implement cancellation trigger → grace period
- [ ] Implement grace period expiration → 1PP custody
- [ ] Implement new lead creation → auto custody assignment
- [ ] Implement area transfer → lead custody transfer

### Phase 3: Admin UI (Week 5-6)
- [ ] Lead custody dashboard
- [ ] Bulk reassignment tools
- [ ] Transaction entry form
- [ ] Commission reports

### Phase 4: Agent Portal (Week 7-8)
- [ ] Licensed leads view
- [ ] Transaction submission
- [ ] Grace period visibility

---

## 9. Success Metrics

| Metric | Current | Target |
|--------|---------|--------|
| Leads with custody tracking | 0% | 100% |
| Orphaned leads | 56,876 | 0 |
| Transaction tracking | None | All converted leads |
| Commission capture | $0 | TBD based on conversion rate |
| Lead reassignment time | N/A | < 24 hours after grace period |

---

## 10. Dependencies

| Dependency | Status | Notes |
|------------|--------|-------|
| FR-001: AreaOwnership Schema | In Progress | Must complete before lead custody links |
| WHMCS Integration | Exists | Needs trigger for cancellation events |
| GenieLead Table | Exists | Will add FK relationship |
| Admin Portal | Exists | Will add new pages |

---

## 11. Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Data migration errors | High | Run in preview mode, verify counts before commit |
| Agent pushback on custody model | Medium | Communicate value (reassignment = fresh leads) |
| Performance impact on lead creation | Low | Async custody record creation |
| Split percentage disputes | Medium | Clear ToS, admin override capability |

---

## 12. Change Log

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 12/15/2025 | Cursor AI | Initial document creation |

---

## 13. Approvals

| Role | Name | Date | Signature |
|------|------|------|-----------|
| Product Owner | | | |
| Technical Lead | | | |
| Database Admin | | | |


