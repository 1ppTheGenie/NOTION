Versium Smart Cache Lookup with Owner Validation 
Date: 12/16/2025

Ankit,

Can you get this fixed ASAP?  Since !1/06/2024 ouyr cost for Versium has skyrocketed due to you disabling the cache system.  

I'm sending this as a guide to get it fixed.  Let me know if you have qyuestions

================================================================================
CORRECT THE LOGIC - THE REAL STRATEGY
================================================================================
Attom data uses same database row as DataTree. The system Looks up a 
property. If there was a Versium cache entry in the past, check if  owner name 
matches. If match ‚Üí Use cache. If different ‚Üí Property transferred, fetch new 
Versium data.

THIS IS THE CORRECT APPROACH:
-----------------------------
‚úÖ Attom data comes in (same database row as DataTree)
‚úÖ Look up property (has both Attom and DataTree IDs)
‚úÖ Check Versium cache using DataTree PropertyID
‚úÖ Validate: Compare owner names
   ‚Ä¢ If owner matches ‚Üí Use cache (property hasn't transferred)
   ‚Ä¢ If owner different ‚Üí Property transferred, fetch new Versium data
   ‚Ä¢ If no cache ‚Üí Fetch new Versium data

================================================================================
THE CORRECTED CACHE LOOKUP LOGIC
================================================================================

STEP 1: Request Comes In (Attom Data)
--------------------------------------
‚Ä¢ Attom PropertyID: 155176603
‚Ä¢ Attom Owner: "Thomas, F"
‚Ä¢ System needs Versium data

STEP 2: Look Up Property Record (Same Database Row)
---------------------------------------------------
‚Ä¢ Query: AssessorDataPropertyMap WHERE AttomId = 155176603
‚Ä¢ Get: DataTreePropertyId = 15237408 (same property, different ID)
‚Ä¢ Property record has BOTH IDs (same row)

STEP 3: Check Versium Cache Using DataTree PropertyID
------------------------------------------------------
‚Ä¢ Look for cache: ::PID-15237408::L-THOMAS::F-F
‚Ä¢ Check if cache entry exists

STEP 4: VALIDATE OWNER NAMES (Critical!)
----------------------------------------
‚Ä¢ Get owner name from Attom data: "Thomas, F"
‚Ä¢ Get owner name from DataTree data: "Thomas, F" (or "Donald Duck")

IF OWNER NAMES MATCH (Attom = DataTree):
  ‚úÖ Property hasn't transferred
  ‚úÖ Check if Versium cache exists
  ‚úÖ If cache exists ‚Üí Use it (saves credits!)
  ‚úÖ If no cache ‚Üí Fetch new Versium data
  
IF OWNER NAMES DIFFERENT (Attom ‚â† DataTree):
  ‚ùå Property transferred (new owner)
  ‚ùå Old Versium cache is for old owner (doesn't matter)
  ‚ùå MUST fetch new Versium data for new owner
  ‚ùå Ignore old cache (it's for wrong owner)
  ‚ùå Fetch fresh Versium data
  ‚ùå Cache with new owner data

================================================================================
THE COMPLETE FLOW (CORRECTED)
================================================================================

REQUEST: Attom PropertyID 155176603, Owner "Thomas, F"
-------------------------------------------------------

1. LOOK UP PROPERTY RECORD
   ------------------------
   SELECT DataTreePropertyId 
   FROM AssessorDataPropertyMap 
   WHERE AttomId = 155176603
   ‚Üí Result: DataTreePropertyId = 15237408

2. CHECK VERSIUM CACHE (Using DataTree PropertyID)
   -------------------------------------------------
   SELECT * FROM DataAppendContactLookup
   WHERE LookupKeyReadable LIKE '::PID-15237408::L-THOMAS::F-F%'
   ‚Üí Result: Cache entry found (or not found)

3. VALIDATE OWNER NAMES (Critical!)
   --------------------------------
   ‚Ä¢ Get owner from Attom data: "Thomas, F"
   ‚Ä¢ Get owner from DataTree data: "Thomas, F" (or "Donald Duck")
   
   IF OWNER NAMES MATCH (Attom = DataTree):
     ‚úÖ Property hasn't transferred
     ‚úÖ Check Versium cache (using DataTree PropertyID)
     ‚úÖ If cache exists ‚Üí Use it (saves credits!)
     ‚úÖ If no cache ‚Üí Fetch new Versium data
     
   IF OWNER NAMES DIFFERENT (Attom ‚â† DataTree):
     ‚ùå Property transferred (new owner)
     ‚ùå Old Versium cache is for old owner (ignore it)
     ‚ùå MUST fetch new Versium data for new owner
     ‚ùå Continue to Step 4 (fetch new data)

4. FETCH NEW VERSIUM DATA (If No Cache or Owner Changed)
   ------------------------------------------------------
   ‚Ä¢ Call Versium API with Attom PropertyID
   ‚Ä¢ Get fresh Versium data
   ‚Ä¢ Cache with Attom PropertyID: ::PID-155176603::L-THOMAS::F-F
   ‚Ä¢ CreditsUsed = 22

================================================================================
THE CODE LOGIC (CORRECTED)
================================================================================

```csharp
// Step 1: Get DataTree PropertyID from Attom PropertyID
var dataTreePropertyId = GetDataTreePropertyIdFromAttom(input.PropertyId);
// Query: AssessorDataPropertyMap WHERE AttomId = input.PropertyId

// Step 2: Check Versium cache using DataTree PropertyID
var dataTreeCacheKey = Utility.GetLookupCacheKeyReadable(
    dataTreePropertyId,  // DataTree ID
    input.FirstName, 
    input.LastName
);
var cachedData = LoadCache(dataTreeCacheKey);

// Step 3: Validate owner names (Attom vs DataTree)
var attomOwnerName = $"{input.LastName}, {input.FirstName}"; // "Thomas, F"
var dataTreeOwnerName = GetDataTreeOwnerName(dataTreePropertyId); // "Thomas, F" or "Donald Duck"

if (attomOwnerName.Equals(dataTreeOwnerName, StringComparison.OrdinalIgnoreCase)) {
    // Owner names match - property hasn't transferred
    // Check Versium cache
    if (cachedData != null) {
        // Cache exists - use it (saves credits!)
        return cachedData;
    } else {
        // No cache - fetch new Versium data
        // Continue to Step 4
    }
} else {
    // Owner names different - property transferred
    // Old Versium cache is for old owner (ignore it)
    // MUST fetch new Versium data for new owner
    // Continue to Step 4 (fetch new data)
}

// Step 4: Fetch new Versium data
// (Either no cache, or owner changed)
var newVersiumData = CallVersiumAPI(input.PropertyId); // Attom ID

// Step 5: Cache with Attom PropertyID (going forward)
var attomCacheKey = Utility.GetLookupCacheKeyReadable(
    input.PropertyId,  // Attom ID
    input.FirstName, 
    input.LastName
);
SaveCache(attomCacheKey, newVersiumData);
```


THE SOLUTION:
------------------
‚Ä¢ Look up property record (Attom ‚Üí DataTree mapping)
‚Ä¢ Check Versium cache using DataTree PropertyID
‚Ä¢ Validate cache with owner name comparison
‚Ä¢ Use cache if valid, fetch new if stale
‚Ä¢ Cache new data with Attom PropertyID

THIS IS THE CORRECT APPROACH! üéØ

================================================================================

